<!DOCTYPE html> <!---  to enter in page we should use this url with port 8081 http://localhost:8081/genereDiagrammeClass.html-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Diagram with Mermaid.js</title>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: false });
        window.mermaid = mermaid;
    </script>
</head>
<body>

<h1>Class Diagram for Cabinet Medical</h1>
<div class="mermaid" id="classDiagram"></div>

<script>
const apiUrl = "http://localhost:8080/api/resource_templates?key_identity=xtfoD9E65s6ZPYVn9bovh7yjNlkBMlu7&key_credential=YAVM7f2mBRJxZsiVmifIS2Cbh81si3cO";
let mermaidText = "classDiagram\n";

// Function to fetch property label based on the property URL
async function fetchPropertyLabel(propertyUrl) {
    try {
        const response = await fetch(propertyUrl);
        const data = await response.json();
        return data["o:label"] || "UnnamedProperty";
    } catch (error) {
        console.error("Error fetching property label:", error);
        return "UnnamedProperty";
    }
}

// Fetch resource templates and process each property
fetch(apiUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then(async (data) => {
        // Process each template to create a class in Mermaid syntax
        for (const template of data) {
            // Set a class name, replacing spaces with underscores
            const className = template["o:label"] ? template["o:label"].replace(/\s+/g, '_') : "UnnamedClass";
            mermaidText += `class ${className} {\n`;

            // Extract properties and check for null or undefined cases
            const properties = template["o:resource_template_property"];
            if (properties && properties.length > 0) {
                for (const prop of properties) {
                    // Fetch the actual label for each property
                    const propertyUrl = prop["o:property"] && prop["o:property"]["@id"];
                    const propertyLabel = propertyUrl ? await fetchPropertyLabel(propertyUrl) : "UnnamedProperty";
                    const propertyType = prop["o:data_type"] && prop["o:data_type"].length > 0 ? prop["o:data_type"][0]["o:label"] : "String";

                    // Replace spaces in property names with underscores for Mermaid compatibility
                    const sanitizedPropertyName = propertyLabel.replace(/\s+/g, '_');
                    mermaidText += `    +${propertyType} ${sanitizedPropertyName}\n`;
                }
            } else {
                // Placeholder if no properties are defined
                mermaidText += "    +String placeholderProperty\n";
            }
            mermaidText += "}\n";
        }

        // Log the generated Mermaid text for debugging
        console.log(mermaidText);

        // Insert the generated Mermaid code into the HTML container
        document.getElementById("classDiagram").innerHTML = mermaidText;
        
        // Render the diagram with Mermaid
        mermaid.init(undefined, document.querySelectorAll(".mermaid"));
    })
    .catch(error => {
        console.error("Error fetching resource templates:", error);
        document.getElementById("classDiagram").innerHTML = "Failed to load data.";
    });
</script>

</body>
</html>